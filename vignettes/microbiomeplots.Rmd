---
title: "Introduction to microbiomeplots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to microbiomeplots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

## Overview

The `microbiomeplots` package provides an easy way to visualize complex microbiome dynamics. It builds on top of `phyloseq`, `microViz`, and `ggplot2` to offer aesthetically pleasing and highly informative "star/radar" plots. These visualizations are particularly useful for seeing differences in microbial composition and relative abundance alongside ordination spaces.

## Setup

```{r setup, eval=FALSE}
library(microbiomeplots)
library(phyloseq)
library(dplyr)
library(ggplot2)
library(microViz)

# For demonstrations, we will use the GlobalPatterns dataset
data(GlobalPatterns)
# Filter down to speed up example vignettes
# Subset to a smaller physeq for demonstration, fix taxa with microViz
gp <- subset_samples(GlobalPatterns, SampleType %in% c("Feces", "Skin", "Tongue"))
gp <- gp %>% tax_fix()
# Only taxa without zero counts remain
gp <- subset_taxa(gp, taxa_sums(gp) > 0)
```

## Functionality

### 1. `plot_taxa_star()`

This function creates radar/star plots to visualize the relative abundance of specified taxa (or the top N taxa automatically) across different sample groups.

```{r taxa-star, eval=FALSE}
# Plot the top 4 most abundant orders by SampleType
taxa_plot <- plot_taxa_star(
    physeq = gp,
    sample_var = "SampleType",
    taxa_rank = "Order",
    samplecolumn = "X.SampleID",
    error_bar = "SE",
    plot_order = "hclust"
)
print(taxa_plot)
```

### 2. `plot_pcoa_star()`

Ordination is a cornerstone of microbiome analysis. `plot_pcoa_star` performs Principal Coordinate Analysis (PCoA) on distance matrices (like Bray-Curtis) and replaces standard points with star plots representing the actual taxonomic composition of each sample in the ordination space.

```{r pcoa-star, eval=FALSE}
# Create PCoA plot with embedded taxa abundance star plots
plot_pcoa_star(
    physeq = gp,
    sample_var = "SampleType",
    distance = "bray",
    view_type = "separate"
)
# Create PCoA plot with embedded taxa abundance star plots
# Samples are grouped by SampleType but displayed together
pcoa_plot <- plot_pcoa_star(
    physeq = gp,
    sample_var = "SampleType",
    distance = "bray",
    view_type = "together"
)
print(pcoa_plot)
```


### 3. `coreselect()`

`coreselect` allows you to subset your phyloseq object by comparing the core microbiome across 2 to 7 groups. It produces a clear presence/absence heatmap to compare which taxa meet your core definitions in each sample type.
Using this requires groups that have substantial overlap in taxa composition, and where the core taxa exclusive to one group are an area of interest. 
Let's make sure that we have groups that have substantial overlap in taxa composition, and where the core taxa exclusive to one group. 
```{r reproduction_data, eval=FALSE}
set.seed(001)
n_samples_per_group <- 20
groups <- c("Control", "TreatmentA", "TreatmentB")
n_samples <- n_samples_per_group * length(groups)
n_taxa <- 25

# Create Taxa Names
taxa_names <- paste0("Taxon_", LETTERS[1:n_taxa])

# OTU Table
# Initialize with zeros
otu_mat <- matrix(0, nrow = n_taxa, ncol = n_samples)
rownames(otu_mat) <- taxa_names
colnames(otu_mat) <- paste0("Sample", 1:n_samples)
taxa_TABLE <- as.matrix(taxa_names)
rownames(taxa_TABLE) <- taxa_names
taxa_tables <- tax_table(taxa_TABLE)
# Assign groups
group_vec <- rep(groups, each = n_samples_per_group)
meta_df <- data.frame(
    SampleID = colnames(otu_mat),
    Group = group_vec,
    row.names = colnames(otu_mat)
)

# Populate OTU table with patterns

for (isValid in 1:n_samples) {
    grp <- group_vec[isValid]

    # Taxon A/M/W: Core in Control
    if (grp == "Control") {
        otu_mat["Taxon_A", isValid] <- 100
        otu_mat["Taxon_M", isValid] <- 10
        otu_mat["Taxon_W", isValid] <- 100
    }

    # Taxon A/M: Conditional presence in Treatments (40% chance)
    if (grp %in% c("TreatmentB", "TreatmentA") && runif(1) < 0.4) {
        otu_mat[c("Taxon_A", "Taxon_M"), isValid] <- 30
    }

    # Taxon B: Core in Control and TreatmentA
    if (grp %in% c("Control", "TreatmentA") && runif(1) < 0.8) {
        otu_mat["Taxon_B", isValid] <- 50
        otu_mat["Taxon_N", isValid] <- 100
        otu_mat["Taxon_O", isValid] <- 10
    }

    # Taxon B: Conditional presence in TreatmentB (30% chance)
    if (grp == "TreatmentB" && runif(1) < 0.3) {
        otu_mat[c("Taxon_B", "Taxon_N", "Taxon_O"), isValid] <- 30
    }

    # Taxon C: Core in TreatmentA
    if (grp == "TreatmentA") {
        otu_mat["Taxon_C", isValid] <- 200
        otu_mat["Taxon_P", isValid] <- 3
        otu_mat["Taxon_Q", isValid] <- 70
    }
    if (grp == "TreatmentB" && runif(1) < 0.3) {
        otu_mat["Taxon_C", isValid] <- 200
        otu_mat["Taxon_P", isValid] <- 3
        otu_mat["Taxon_Q", isValid] <- 70
    }
    # Taxon C: Conditional presence in TreatmentB (30% chance)
    if (grp == "TreatmentB" && runif(1) < 0.3) {
        otu_mat[c("Taxon_C", "Taxon_P", "Taxon_Q"), isValid] <- 20
    }

    # Taxon D: Core in TreatmentB
    if (grp == "TreatmentB") {
        otu_mat["Taxon_D", isValid] <- 500
        otu_mat["Taxon_R", isValid] <- 70
    }
    if (grp == "TreatmentA" && runif(1) < 0.2) {
        otu_mat["Taxon_D", isValid] <- 500
        otu_mat["Taxon_R", isValid] <- 70
    }
    # Taxon E-L: Random presence (20-70%) across all samples
    if (runif(1) < 0.2) otu_mat[c("Taxon_E", "Taxon_S", "Taxon_T", "Taxon_U", "Taxon_V"), isValid] <- 30
    if (runif(1) < 0.3) otu_mat["Taxon_F", isValid] <- 10
    if (runif(1) < 0.4) otu_mat["Taxon_G", isValid] <- 10
    if (runif(1) < 0.6) otu_mat["Taxon_H", isValid] <- 10
    if (runif(1) < 0.7) otu_mat["Taxon_I", isValid] <- 10
    if (runif(1) < 0.5) otu_mat["Taxon_J", isValid] <- 10
    if (runif(1) < 0.5) otu_mat["Taxon_K", isValid] <- 10
    if (runif(1) < 0.5) otu_mat["Taxon_L", isValid] <- 10
}
physeq <- phyloseq(
    otu_table(otu_mat, taxa_are_rows = TRUE), tax_table(taxa_tables),
    sample_data(meta_df)
)
```
```{r coreselect, eval=FALSE}
# Output a core comparison presence-absence plot
core_res <- coreselect(
    physeq = physeq,
    group_var = "Group",
    percent_samples = 80, # 50% prevalence
    abundance_threshold = 0
)

# Render the presence/absence plot
print(core_res)
```
### 4. `plot_core_matrix()`

To compare what taxa are uniquely "core" to different groups, `plot_core_matrix` creates a faceted matrix of star plots. Each quadrant isolates the core taxa present _exclusively_ in one group's core compared to the others.

```{r core-matrix, eval=FALSE}
# Compare unique core taxa between groups
coreplot <- plot_core_matrix(
    physeq = physeq,
    group_var = "Group",
    percent_samples = 0.8, # don't worry. 0.8 is 80%
    abundance_threshold = 0,
    taxa_rank = "OTU",
    samplecolumn = "SampleID",
    log_scale = TRUE
)
print(coreplot)
```
